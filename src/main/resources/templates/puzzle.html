<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Chessmate - Mode Puzzle</title>

    <link rel="stylesheet" th:href="@{/css/show.css}">

    <style>

        .case {
            cursor: pointer;
        }


        .case.selected-start {
            background-color: rgba(255, 215, 0, 0.7) !important; /* Jaune dor√© semi-transparent */
            box-shadow: inset 0 0 10px #b8860b;
            border: 2px solid orange;
        }

        .message.success {
            background-color: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #c3e6cb;
        }
    </style>
</head>
<body>
<h1>üß† Chessmate - Puzzle Al√©atoire ‚ôü</h1>

<div th:if="${message}" class="message" th:text="${message}"
     style="text-align:center; padding:10px; margin:10px; background:#333; color:white; border-radius:5px;"></div>

<div class="action-buttons-container" style="margin-bottom: 20px; text-align: center;">

    <form action="/api/puzzle" method="post" style="display:inline;">
        <input type="hidden" th:if="${_csrf}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        <button type="submit" class="btn btn-warning">üß© Charger un Nouveau Puzzle</button>
    </form>

    <a th:href="@{/home}" class="btn btn-secondary">üè† Retour √† l'accueil</a>
</div>

<div class="container">

    <div class="board-container">
        <div class="board" id="board">

            <div th:each="i : ${#numbers.sequence(7, 0, -1)}">
                <div th:each="j : ${#numbers.sequence(0, 7)}"
                /* Alternance des couleurs des cases (Noir/Blanc) selon la parit√© */
                th:class="${(i + j) % 2 == 0} ? 'case white' : 'case black'"
                /* Stockage des coordonn√©es X,Y dans des attributs data-* pour le JS */
                th:attr="data-x=${i}, data-y=${j}"
                /* Affichage du symbole de la pi√®ce */
                th:text="${board[i][j]}"
                /* Gestionnaire d'√©v√©nement click */
                onclick="clickPuzzleCase(this)">
            </div>
        </div>
    </div>
</div>

<div class="info-panel">
    <h3>Statut du Puzzle</h3>
    <p><strong>Joueur :</strong> <span th:text="${pseudo}"></span></p>

    <p><strong>Au trait :</strong>
        <span th:if="${traitAuBlanc}" style="color:blue; font-weight:bold;">BLANCS ‚ö™</span>
        <span th:unless="${traitAuBlanc}" style="color:red; font-weight:bold;">NOIRS ‚ö´</span>
    </p>

    <p style="margin-top: 20px;"><strong>Objectif :</strong> Trouvez le meilleur coup !</p>

    <div th:if="${game.estPuzzleResolu()}" class="message success">
        <h2>üéâ Puzzle R√©solu !</h2>
        <p>Bravo ! +10 points.</p>
    </div>

    <form method="post" action="/reset" style="margin-top: 20px;">
        <input type="hidden" th:if="${_csrf}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        <button type="submit" class="action-btn danger">R√©initialiser le plateau</button>
    </form>
</div>
</div>

<form method="post" action="/move" id="moveForm">
    <input type="hidden" th:if="${_csrf}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

    <input type="hidden" name="departX" id="departX">
    <input type="hidden" name="departY" id="departY">

    <input type="hidden" name="arriveeX" id="arriveeX">
    <input type="hidden" name="arriveeY" id="arriveeY">
</form>

<script>
    let startCase = null;

    /**
     * Gestionnaire de clics pour le puzzle.
     * Impl√©mente une logique en deux √©tapes :
     * 1. S√©lection (highlight jaune)
     * 2. Action (D√©placement et soumission)
     *
     * @param {HTMLElement} element - L'√©l√©ment DOM de la case cliqu√©e.
     */
    function clickPuzzleCase(element) {
        const x = element.getAttribute('data-x');
        const y = element.getAttribute('data-y');

        if (startCase === null) {

            if (element.textContent.trim() !== '') {
                startCase = element;
                element.classList.add('selected-start'); // Feedback visuel pour l'utilisateur
            } else {
                // Ignore les clics sur les cases vides si aucune pi√®ce n'est s√©lectionn√©e
                console.log("Clic sur case vide ignor√©");
            }
        }
        else {
            const departX = startCase.getAttribute('data-x');
            const departY = startCase.getAttribute('data-y');

            const arriveeX = x;
            const arriveeY = y;

            startCase.classList.remove('selected-start');
            startCase = null;

            if (departX === arriveeX && departY === arriveeY) {
                return;
            }

            document.getElementById('departX').value = departX;
            document.getElementById('departY').value = departY;
            document.getElementById('arriveeX').value = arriveeX;
            document.getElementById('arriveeY').value = arriveeY;

            document.getElementById('moveForm').submit();
        }
    }
</script>
</body>
</html>