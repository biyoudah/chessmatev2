<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Chessmate - Mode Puzzle</title>
    <link rel="stylesheet" th:href="@{/css/show.css}">
    <style>
        /* CSS sp√©cifique pour le mode puzzle */
        .case {
            cursor: pointer; /* Indique qu'on peut cliquer */
        }

        /* Quand une case est s√©lectionn√©e (1er clic) */
        .case.selected-start {
            background-color: rgba(255, 215, 0, 0.7) !important; /* Jaune */
            box-shadow: inset 0 0 10px #b8860b;
            border: 2px solid orange;
        }

        /* Message de succ√®s */
        .message.success {
            background-color: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #c3e6cb;
        }
    </style>
</head>
<body>
<h1>üß† Chessmate - Puzzle du Jour ‚ôü</h1>

<div th:if="${message}" class="message" th:text="${message}"
     style="text-align:center; padding:10px; margin:10px; background:#333; color:white; border-radius:5px;"></div>

<div class="action-buttons-container" style="margin-bottom: 20px; text-align: center;">
    <form action="/api/puzzle" method="post" style="display:inline;">
        <input type="hidden" th:if="${_csrf}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        <button type="submit" class="btn btn-warning">üß© Charger un Nouveau Puzzle</button>
    </form>

    <a th:href="@{/home}" class="btn btn-secondary">üè† Retour √† l'accueil</a>
</div>

<div class="container">

    <div class="board-container">
        <div class="board" id="board">
            <div th:each="i : ${#numbers.sequence(7, 0, -1)}">
                <div th:each="j : ${#numbers.sequence(0, 7)}"
                     th:class="${(i + j) % 2 == 0} ? 'case white' : 'case black'"
                     th:attr="data-x=${i}, data-y=${j}"
                     th:text="${board[i][j]}"
                     onclick="clickPuzzleCase(this)">
                </div>
            </div>
        </div>
    </div>

    <div class="info-panel">
        <h3>Statut du Puzzle</h3>
        <p><strong>Joueur :</strong> <span th:text="${pseudo}"></span></p>

        <p><strong>Au trait :</strong>
            <span th:if="${traitAuBlanc}" style="color:blue; font-weight:bold;">BLANCS ‚ö™</span>
            <span th:unless="${traitAuBlanc}" style="color:red; font-weight:bold;">NOIRS ‚ö´</span>
        </p>

        <p style="margin-top: 20px;"><strong>Objectif :</strong> Trouvez le meilleur coup !</p>

        <div th:if="${game.estPuzzleResolu()}" class="message success">
            <h2>üéâ Puzzle R√©solu !</h2>
            <p>Bravo ! +10 points.</p>
        </div>

        <form method="post" action="/reset" style="margin-top: 20px;">
            <input type="hidden" th:if="${_csrf}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <button type="submit" class="action-btn danger">R√©initialiser le plateau</button>
        </form>
    </div>
</div>

<form method="post" action="/move" id="moveForm">
    <input type="hidden" th:if="${_csrf}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

    <input type="hidden" name="departX" id="departX">
    <input type="hidden" name="departY" id="departY">

    <input type="hidden" name="arriveeX" id="arriveeX">
    <input type="hidden" name="arriveeY" id="arriveeY">
</form>

<script>
    // Variable pour m√©moriser la case de d√©part (clic 1)
    let startCase = null;

    /**
     * Gestion des clics :
     * 1er clic = S√©lection (D√©part)
     * 2√®me clic = Action (Arriv√©e)
     */
    function clickPuzzleCase(element) {
        // R√©cup√®re les coordonn√©es depuis les attributs data-x et data-y
        const x = element.getAttribute('data-x');
        const y = element.getAttribute('data-y');

        // --- CLIC 1 : S√âLECTION ---
        if (startCase === null) {
            // On ne peut s√©lectionner qu'une case qui contient une pi√®ce (texte non vide)
            if (element.textContent.trim() !== '') {
                startCase = element;
                element.classList.add('selected-start'); // Ajoute le style jaune
            } else {
                // Optionnel : ne rien faire si on clique sur du vide
                console.log("Clic sur case vide ignor√©");
            }
        }
        // --- CLIC 2 : D√âPLACEMENT ---
        else {
            // R√©cup√®re les coords de la case de d√©part m√©moris√©e
            const departX = startCase.getAttribute('data-x');
            const departY = startCase.getAttribute('data-y');

            // Les coords de la case actuelle (destination)
            const arriveeX = x;
            const arriveeY = y;

            // Nettoyage visuel
            startCase.classList.remove('selected-start');
            startCase = null;

            // Si on a cliqu√© deux fois sur la m√™me case, on annule juste la s√©lection
            if (departX === arriveeX && departY === arriveeY) {
                return;
            }

            // Remplissage du formulaire cach√©
            document.getElementById('departX').value = departX;
            document.getElementById('departY').value = departY;
            document.getElementById('arriveeX').value = arriveeX;
            document.getElementById('arriveeY').value = arriveeY;

            // Envoi au serveur
            document.getElementById('moveForm').submit();
        }
    }
</script>
</body>
</html>